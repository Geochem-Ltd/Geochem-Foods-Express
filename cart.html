<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shopping Cart — Geochem Foods Express</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --gfe-green: #1B5E20;
      --gfe-red: #D32F2F;
      --gfe-gold: #D4AF37;
      --gfe-bg: #FAF9F6;
      --gfe-text: #222222;
    }
    * { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      background: var(--gfe-bg);
      color: var(--gfe-text);
      font-family: 'Inter', 'Poppins', 'Nunito Sans', system-ui, -apple-system, sans-serif;
    }
    .sidebar-link {
      transition: all 0.3s ease;
    }
    .sidebar-link:hover {
      background-color: rgba(27, 94, 32, 0.1);
      transform: translateX(4px);
    }
    .sidebar-link.active {
      background-color: var(--gfe-green);
      color: white;
    }
  </style>
</head>
<body class="antialiased">
  <!-- New cart page with dashboard layout -->
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 fixed h-full overflow-y-auto z-40 transition-transform duration-300 -translate-x-full md:translate-x-0">
      <div class="p-6">
        <a href="index.html" class="flex items-center gap-2 mb-8">
          <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/image-cooU6mMI1RFeCvJAXMg1wACaOoRpCt.png" alt="GFE Logo" class="w-10 h-10 object-contain" loading="lazy" />
          <div>
            <div class="font-bold text-sm text-[var(--gfe-red)]">GEOCHEM</div>
            <div class="font-semibold text-xs text-[var(--gfe-green)]">Foods Express</div>
          </div>
        </a>

        <div class="mb-6 p-4 bg-gradient-to-r from-[var(--gfe-green)]/10 to-[var(--gfe-gold)]/10 rounded-lg">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-[var(--gfe-green)] text-white rounded-full flex items-center justify-center">
              <i class="fas fa-user text-xl"></i>
            </div>
            <div>
              <div id="user-display-name" class="font-semibold text-sm text-[var(--gfe-text)]">Loading...</div>
              <div class="text-xs text-gray-600">Customer</div>
            </div>
          </div>
        </div>

        <nav class="space-y-2">
          <a href="marketplace.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-[var(--gfe-text)]">
            <i class="fas fa-store w-5"></i>
            <span>Marketplace</span>
          </a>
          <a href="profile.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-[var(--gfe-text)]">
            <i class="fas fa-user w-5"></i>
            <span>Profile</span>
          </a>
          <a href="analytics.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-[var(--gfe-text)]">
            <i class="fas fa-chart-line w-5"></i>
            <span>Analytics</span>
          </a>
          <a href="cart.html" class="sidebar-link active flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium">
            <i class="fas fa-shopping-cart w-5"></i>
            <span>Cart</span>
          </a>
          <a href="settings.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-[var(--gfe-text)]">
            <i class="fas fa-cog w-5"></i>
            <span>Settings</span>
          </a>
          <hr class="my-4" />
          <button id="logout-btn" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-[var(--gfe-red)] hover:bg-red-50">
            <i class="fas fa-sign-out-alt w-5"></i>
            <span>Logout</span>
          </button>
        </nav>
      </div>
    </aside>

    <!-- Add overlay for mobile sidebar -->
    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black/50 z-30 md:hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 md:ml-64 p-4 md:p-8 transition-all duration-300">
      <!-- Mobile Menu Toggle -->
      <button id="menu-toggle" class="md:hidden mb-4 p-2 bg-white rounded-lg border border-gray-300">
        <i class="fas fa-bars text-[var(--gfe-green)]"></i>
      </button>

      <header class="mb-8">
        <h1 class="text-3xl font-bold text-[var(--gfe-text)] mb-2">Shopping Cart</h1>
        <p class="text-gray-600">Review your items and proceed to checkout</p>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Cart Items -->
        <div class="lg:col-span-2">
          <div id="cart-items" class="space-y-4">
            <!-- Cart items will be populated here -->
          </div>
        </div>

        <!-- Order Summary -->
        <div class="lg:col-span-1">
          <div class="bg-white rounded-xl shadow-md p-6 sticky top-8">
            <h3 class="text-lg font-bold text-[var(--gfe-text)] mb-4">Order Summary</h3>
            
            <div class="space-y-3 mb-6 pb-6 border-b border-gray-200">
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Subtotal</span>
                <span id="subtotal" class="font-semibold">₦0</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Delivery Fee</span>
                <span class="font-semibold">₦2,500</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Tax (5%)</span>
                <span id="tax" class="font-semibold">₦0</span>
              </div>
            </div>

            <div class="flex justify-between mb-6">
              <span class="font-bold text-[var(--gfe-text)]">Total</span>
              <span id="total" class="text-2xl font-bold text-[var(--gfe-green)]">₦0</span>
            </div>

            <button id="checkout-btn" class="w-full px-6 py-4 bg-[var(--gfe-green)] text-white rounded-lg font-bold hover:bg-[#0d3a1a] transition">
              <i class="fas fa-shopping-bag mr-2"></i>Proceed to Checkout
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Checkout Modal -->
  <div id="checkout-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white">
        <h2 class="text-2xl font-bold text-[var(--gfe-text)]">Checkout</h2>
        <button id="close-modal" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center">
          <i class="fas fa-times text-gray-600"></i>
        </button>
      </div>

      <div class="p-6">
        <!-- Delivery Information -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-[var(--gfe-text)] mb-4">Delivery Information</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
              <input type="text" id="checkout-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--gfe-green)]" placeholder="Enter your full name" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
              <input type="tel" id="checkout-phone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--gfe-green)]" placeholder="+234 XXX XXX XXXX" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Address</label>
              <textarea id="checkout-address" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--gfe-green)]" placeholder="Enter your complete delivery address"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">City / State</label>
              <input type="text" id="checkout-city" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--gfe-green)]" placeholder="e.g., Awka, Anambra" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes (Optional)</label>
              <textarea id="checkout-notes" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--gfe-green)]" placeholder="Any special instructions for delivery"></textarea>
            </div>
          </div>
        </div>

        <!-- Order Summary in Modal -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <h3 class="font-semibold text-[var(--gfe-text)] mb-3">Order Summary</h3>
          <div id="modal-cart-items" class="space-y-2 mb-3">
            <!-- Items will be populated here -->
          </div>
          <div class="pt-3 border-t border-gray-300">
            <div class="flex justify-between font-bold text-[var(--gfe-text)]">
              <span>Total</span>
              <span id="modal-total" class="text-[var(--gfe-green)]">₦0</span>
            </div>
          </div>
        </div>

        <!-- WhatsApp Checkout Button -->
        <button id="whatsapp-checkout-btn" class="w-full px-6 py-4 bg-[#25D366] text-white rounded-lg font-bold hover:brightness-90 transition flex items-center justify-center gap-2">
          <i class="fab fa-whatsapp text-2xl"></i>
          <span>Complete Order via WhatsApp</span>
        </button>
        <p class="text-xs text-gray-600 text-center mt-3">
          <i class="fas fa-lock mr-1"></i>Secure checkout powered by WhatsApp
        </p>
      </div>
    </div>
  </div>

  <script type="module">
    import { checkAuth, signOutUser } from './assets/js/auth-firebase.js';
    
    const user = await checkAuth();
    if (!user) {
      Swal.fire({
        icon: 'warning',
        title: 'Authentication Required',
        text: 'Please login to access your cart',
        confirmButtonText: 'Go to Login'
      }).then(() => {
        window.location.href = 'login.html';
      });
    } else {
      document.getElementById('user-display-name').textContent = user.displayName || user.email;
    }
    
    // Mobile sidebar toggle
    import { initDashboardNav } from './assets/js/nav-handler.js';
    initDashboardNav();
    
    // Logout functionality
    document.getElementById('logout-btn').addEventListener('click', async () => {
      const result = await Swal.fire({
        title: 'Logout?',
        text: 'Are you sure you want to logout?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, logout',
        cancelButtonText: 'Cancel'
      });
      
      if (result.isConfirmed) {
        await signOutUser();
        Swal.fire({
          icon: 'success',
          title: 'Logged Out',
          timer: 1500,
          showConfirmButton: false
        }).then(() => {
          window.location.href = 'index.html';
        });
      }
    });
    
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    
    function renderCart() {
      const container = document.getElementById('cart-items');
      container.innerHTML = '';
      
      if (cart.length === 0) {
        container.innerHTML = `
          <div class="bg-white rounded-xl p-12 text-center">
            <i class="fas fa-shopping-cart text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">Your cart is empty</h3>
            <p class="text-gray-500 mb-6">Add some products to get started</p>
            <a href="marketplace.html" class="inline-block px-6 py-3 bg-[var(--gfe-green)] text-white rounded-lg font-semibold hover:bg-[#0d3a1a] transition">
              Browse Products
            </a>
          </div>
        `;
        updateTotals();
        return;
      }
      
      cart.forEach((item, index) => {
        const el = document.createElement('div');
        el.className = 'bg-white rounded-xl p-4 shadow-md flex items-center gap-4';
        el.innerHTML = `
          <img src="${item.image}" alt="${item.name}" class="w-20 h-20 rounded-lg object-cover" />
          <div class="flex-1">
            <h3 class="font-semibold text-[var(--gfe-text)]">${item.name}</h3>
            <p class="text-sm text-gray-600">${item.category}</p>
            <p class="text-lg font-bold text-[var(--gfe-green)] mt-1">₦${item.price.toLocaleString()}</p>
          </div>
          <div class="flex items-center gap-3">
            <button onclick="updateQuantity(${index}, -1)" class="w-8 h-8 rounded-full border border-gray-300 hover:bg-gray-100 flex items-center justify-center">
              <i class="fas fa-minus text-xs"></i>
            </button>
            <span class="font-semibold w-8 text-center">${item.quantity}</span>
            <button onclick="updateQuantity(${index}, 1)" class="w-8 h-8 rounded-full border border-gray-300 hover:bg-gray-100 flex items-center justify-center">
              <i class="fas fa-plus text-xs"></i>
            </button>
          </div>
          <button onclick="removeItem(${index})" class="w-10 h-10 rounded-full hover:bg-red-50 flex items-center justify-center text-[var(--gfe-red)]">
            <i class="fas fa-trash"></i>
          </button>
        `;
        container.appendChild(el);
      });
      
      updateTotals();
    }
    
    function updateTotals() {
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const deliveryFee = cart.length > 0 ? 2500 : 0;
      const tax = Math.round(subtotal * 0.05);
      const total = subtotal + deliveryFee + tax;
      
      document.getElementById('subtotal').textContent = `₦${subtotal.toLocaleString()}`;
      document.getElementById('tax').textContent = `₦${tax.toLocaleString()}`;
      document.getElementById('total').textContent = `₦${total.toLocaleString()}`;
      document.getElementById('modal-total').textContent = `₦${total.toLocaleString()}`;
    }
    
    window.updateQuantity = function(index, change) {
      cart[index].quantity += change;
      if (cart[index].quantity <= 0) {
        cart.splice(index, 1);
      }
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
    };
    
    window.removeItem = function(index) {
      Swal.fire({
        title: 'Remove Item?',
        text: 'Are you sure you want to remove this item from your cart?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, remove it',
        confirmButtonColor: '#d33'
      }).then((result) => {
        if (result.isConfirmed) {
          cart.splice(index, 1);
          localStorage.setItem('cart', JSON.stringify(cart));
          renderCart();
          Swal.fire('Removed!', 'Item has been removed from your cart', 'success');
        }
      });
    };
    
    const modal = document.getElementById('checkout-modal');
    const checkoutBtn = document.getElementById('checkout-btn');
    const closeModal = document.getElementById('close-modal');
    const whatsappBtn = document.getElementById('whatsapp-checkout-btn');
    
    checkoutBtn.addEventListener('click', () => {
      if (cart.length === 0) {
        Swal.fire('Empty Cart', 'Please add items to your cart before checkout', 'warning');
        return;
      }
      
      // Populate modal cart items
      const modalItems = document.getElementById('modal-cart-items');
      modalItems.innerHTML = cart.map(item => `
        <div class="flex justify-between text-sm">
          <span>${item.name} x${item.quantity}</span>
          <span class="font-semibold">₦${(item.price * item.quantity).toLocaleString()}</span>
        </div>
      `).join('');
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    });
    
    closeModal.addEventListener('click', () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    });
    
    whatsappBtn.addEventListener('click', () => {
      const name = document.getElementById('checkout-name').value;
      const phone = document.getElementById('checkout-phone').value;
      const address = document.getElementById('checkout-address').value;
      const city = document.getElementById('checkout-city').value;
      const notes = document.getElementById('checkout-notes').value;
      
      if (!name || !phone || !address || !city) {
        Swal.fire('Missing Information', 'Please fill in all required fields', 'warning');
        return;
      }
      
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const deliveryFee = 2500;
      const tax = Math.round(subtotal * 0.05);
      const total = subtotal + deliveryFee + tax;
      
      const orderDetails = `Hello GFE! I would like to place an order:

*Customer Details:*
Name: ${name}
Phone: ${phone}
Address: ${address}
City/State: ${city}
${notes ? `Notes: ${notes}` : ''}

*Order Summary:*
${cart.map(item => `- ${item.name} (x${item.quantity}) - ₦${(item.price * item.quantity).toLocaleString()}`).join('\n')}

*Subtotal:* ₦${subtotal.toLocaleString()}
*Delivery Fee:* ₦${deliveryFee.toLocaleString()}
*Tax (5%):* ₦${tax.toLocaleString()}
*Total:* ₦${total.toLocaleString()}

Please confirm this order and provide payment details.`;

      const encodedMessage = encodeURIComponent(orderDetails);
      const whatsappURL = `https://wa.me/2348031539847?text=${encodedMessage}`;
      
      window.open(whatsappURL, '_blank');
      
      // Clear cart after order
      Swal.fire({
        icon: 'success',
        title: 'Order Sent!',
        text: 'Your order has been sent via WhatsApp. We will contact you shortly.',
        confirmButtonText: 'OK'
      }).then(() => {
        cart = [];
        localStorage.setItem('cart', JSON.stringify(cart));
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        renderCart();
      });
    });
    
    renderCart();
  </script>
</body>
</html>
